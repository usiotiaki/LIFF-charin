<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>charin</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        input { width: 80%; padding: 10px; margin: 10px 0; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        button { width: 85%; padding: 15px; background-color: #00b900; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        #status { margin-top: 20px; color: #666; }
    </style>
</head>
<body>
    <img id="pictureUrl" style="width: 60px; border-radius: 50%; display: none; margin: 0 auto;">
    <p id="displayName">èª­ã¿è¾¼ã¿ä¸­...</p>

    <div id="form" style="display: none;">
        <input type="text" id="item" placeholder="ä½•ã«ä½¿ã£ãŸï¼Ÿ (ä¾‹: ãƒ©ãƒ³ãƒ)">
        <input type="number" id="amount" placeholder="ã„ãã‚‰ï¼Ÿ (ä¾‹: 1000)">
        <button id="sendBtn" onclick="sendData()">ã‚¹ãƒ—ã‚·ã«ä¿å­˜ã™ã‚‹</button>
    </div>
    
    <p id="status"></p>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycby348FC1JqutwojMCm17MvzuV-D7Zx9FtnakA1P1Sg9h7sLznmN4i_bPgxSUmgiMb24/exec";
        let userProfile = null;

        liff.init({ liffId: "2009004003-HY8btsxr" })
        .then(() => {
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                liff.getProfile().then(profile => {
                    userProfile = profile;
                    document.getElementById('displayName').innerText = profile.displayName + "ã•ã‚“ã®å…¥åŠ›";
                    document.getElementById('pictureUrl').src = profile.pictureUrl;
                    document.getElementById('pictureUrl').style.display = "block";
                    document.getElementById('form').style.display = "block";
                });
            }
        })
        .catch(err => alert("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + err));

        async function sendData() {
            const item = document.getElementById('item').value;
            const amount = document.getElementById('amount').value;
            const btn = document.getElementById('sendBtn');
            const status = document.getElementById('status');

            if (!item || !amount) {
                alert("é …ç›®ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                return;
            }

            btn.disabled = true;
            status.innerText = "ä¿å­˜ä¸­...";

            const payload = {
                userName: userProfile.displayName,
                item: item,
                amount: amount
            };

            try {
                // GASã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    status.innerText = "âœ… ä¿å­˜å®Œäº†ï¼";
                    document.getElementById('item').value = "";
                    document.getElementById('amount').value = "";
                    
                    // LINEã®ãƒˆãƒ¼ã‚¯ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é£›ã°ã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    if (liff.isInClient()) {
                        liff.sendMessages([{
                            type: 'text',
                            text: `ğŸ’° ${userProfile.displayName}ãŒã€Œ${item}ã€ã«${amount}å††ä½¿ã£ãŸã‚ˆï¼`
                        }]);
                    }
                }
            } catch (e) {
                status.innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + e;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>